{% extends 'base.html' %}
{% load static %}
{% block title %}Chats Page{% endblock %}
{% block content %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/chats.css' %}">
{% endblock %}

<body data-chat-user="{{ chat_user.username }}">
<div class="chat-layout">
    <div class="chat-container">
      <a href="{% url 'chats' %}" class="close-link">
       <i class='bx bx-x ac-close'></i>
      </a>
             
        <!-- TOP BAR -->
        <div class="chat-header">
          <img src="{{ chat_user.image|default:'/static/images/default-user.webp' }} "  class="chat-header-avatar">
          <span class="chat-header-name">{{ chat_user.username }}</span>
        </div>

        <!-- CHAT BODY -->
        <div class="chat-body">
          


          <!-- Profile Preview -->
          <div class="chat-profile-preview">
            <img src="{{ chat_user.image|default:'/static/images/default-user.webp' }}" class="chat-preview-avatar">
            <h3>{{ chat_user.username }}</h3>
            <a href="{% url 'suggested_user_profile' chat_user.username %}">
            <button class="view-profile-btn">View profile</button>
            </a>
          </div>
          <div class="chat-messages" id="chatMessages">
            {% for msg in messages %}
              {% if msg.sender == me %}
                <div class="chat-msg sent">
                  <div class="chat-bubble">{{ msg.message }}</div>
                </div>
              {% else %}
                <div class="chat-msg received">
                  <div class="chat-bubble">{{ msg.message }}</div>
                </div>
              {% endif %}
            {% endfor %}

          </div>

        </div>

        <!-- INPUT BAR -->
        <div class="chat-input-bar">
          <input type="text" placeholder="Message..." class="chat-input">

          <div class="chat-icons">
            <i class="bx bx-smile"></i>
            
            <i class="bx bx-image"></i>
            <i class="bx bx-send" id="sendMessageBtn"></i>
          </div>
        </div>

        
    </div>

</div>
</body>


<script>
document.addEventListener("DOMContentLoaded", () => {

  const sendBtn = document.getElementById("sendMessageBtn");
  const input = document.querySelector(".chat-input");
  const chatBox = document.getElementById("chatMessages");

  const username = "{{ chat_user.username }}";

  console.log("Connecting WebSocket...");

  const socket = new WebSocket(
    `ws://${window.location.host}/ws/chat/${username}/`
  );

  socket.onopen = () => {
    console.log("‚úÖ WebSocket CONNECTED");
  };

  socket.onerror = (error) => {
    console.log("‚ùå WebSocket ERROR", error);
  };

  socket.onmessage = function (e) {
    const data = JSON.parse(e.data);

    console.log("üì© Received:", data.message);

    const msgDiv = document.createElement("div");
    msgDiv.classList.add("chat-msg", data.sender === "me" ? "sent" : "received");

    msgDiv.innerHTML = `<div class="chat-bubble">${data.message}</div>`;

    chatBox.appendChild(msgDiv);
    chatBox.scrollTop = chatBox.scrollHeight;
  };

  function sendMessage() {
    const msg = input.value.trim();
    if (!msg) return;

    console.log("üì§ Sending:", msg);

    socket.send(JSON.stringify({
      message: msg
    }));

    input.value = "";
  }

  sendBtn.addEventListener("click", sendMessage);

  input.addEventListener("keypress", (e) => {
    if (e.key === "Enter") sendMessage();
  });

});
</script>
{% endblock %}
